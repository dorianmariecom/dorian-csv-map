#!/usr/bin/env ruby
# frozen_string_literal: true

require "csv"
require "optparse"
require "active_support"
require "active_support/core_ext/hash/indifferent_access"

options = { headers: false }

argv =
  OptionParser
    .new do |opts|
      opts.banner = "Usage: cat ... | csv-map [-h|--headers] RUBY\n\n"

      opts.on("-h", "--headers", "with headers") do |parse|
        options[:headers] = true
      end
    end
    .parse!

abort "See --help" if argv.size != 1

puts(
  CSV.generate do |csv|
    parsed = CSV.parse($stdin.each_line.to_a.join, headers: options[:headers])

    csv << parsed.headers if options[:headers]

    parsed.each do |it|
      if options[:headers]
        it = it.to_h.with_indifferent_access
        eval(argv.first)
        csv << it.values
      else
        it = it.to_a
        eval(argv.first)
        csv << it
      end
    end
  end
)
